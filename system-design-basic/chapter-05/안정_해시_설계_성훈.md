# 안정 해시 설계
* Scale-Out한 분산 환경일 떄 일반적으로 사용자의 트래픽을 분산시키기 위해 해시를 사용해 트래픽을 분산시킨다.
  * hash Function 결과 % N
* 해시 분산 Case
  * DB 샤딩 시 해시 값으로 샤드를 분리하는 경우
  * Redis 분산 캐시에서 해시 슬롯 사용 


## 해시 키 재배치(rehash) 문제
* hash Function 결과를 N으로 나눈 나머지로 서버를 선택하는 경우, N이 변경되면 기존에 할당된 키들이 모두 변경되는 문제가 발생한다.
  * DB 샤드 서버가 추가되는 경우 기존 샤드에 저장되어 있던 데이터들이 재할당 되어야 한다.
  * Redis 분산 캐시에서 해시 Slot이 추가되면 기존 데이터들이 재할당되기 때문에 대규모 Cache Miss가 발생할 수 있다.

## 안정 해시 알고리즘
* 기존 안정 해시 알고리즘
  * 서버와 Key를 균등 분포 해시 함수를 통해 해시 링에 배치
  * 키의 위치에서 시계 방향으로 가장 가까운 서버에 키 할당
* ⚠️문제점
  * 인접 서버 사이의 공간인 파티션을 균등하게 유지하기 어렵다. -> 특정 서버가 삭제되면 기존 서버 하나가 많은 파티션 공간을 차지할 수 있다. 
  * 서버와 키를 균등 분포하는 자체가 어렵다 -> 특정 키들이 하나의 서버에 몰릴 수 있다.

* 해당 문제를 해결하기 위해 가상 노드(Virtual Node) 개념을 도입
  * 각 실제 서버를 여러 개의 가상 노드로 매핑
  * 각 가상 노드를 해시 링에 균등 분포
  * 하나의 서버가 N개의 가상 노드를 가지면서 편차가 적어져 균등 분포에 가까워진다.


* **안정 해시를 사용하는 주요 목적은 서버의 추가/제거 시에 재배치 되는 키를 최소화 하는 것이다!**
  * 서버 추가/제거 시 재할당 때문에 특정 서버에 부하가 몰리는 Hot Spot 발생

---
## Reference
https://maily.so/devpill/posts/w6ovlgxyzk5